<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario</title>

    <style>
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input, select {
            width: 100%;
            padding: 6px;
        }

        .img-preview {
            margin-top: 10px;
            max-width: 200px;
            border: 1px solid #ddd;
            padding: 4px;
            display: none;
        }
    </style>
</head>
<body>

  <div class="card mt-3">
    <div class="card-body">
      <h5 class="card-title">Instrucci√≥n por texto</h5>
  
      <form method="get">
        <div class="mb-3">
          <input
            type="text"
            class="form-control"
            name="prompt"
            placeholder="Ej: agregar campo precio_unitario"
            value="{{ request.GET.prompt|default:'' }}"
          >
        </div>
  
        <button type="submit" class="btn btn-primary">
          Enviar instrucci√≥n
        </button>
      </form>
  
    </div>
  </div>

<!-- üß† FORMULARIO DE ESTRUCTURA -->
<form method="post" >
    {% csrf_token %}

    <!-- üßæ CABECERA -->
    <h4>Cabecera</h4>

    <div class="row">
        {% for field in form %}
            <div class="col-md-3 mb-2">
                <label class="form-label">
                    {{ field.label }}
                </label>
                {{ field }}
                {% if field.errors %}
                    <div class="text-danger small">
                        {{ field.errors }}
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>


    ---------------------------------------------------------
    <!-- üì¶ DETALLES -->
    {% if formularios_detalle %}
        <hr>
        <h4>Detalles</h4>
        {% for det in formularios_detalle %}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                {{ det.entidad.tabla|upper }}
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        onclick="agregarFila('{{ forloop.counter0 }}')">
                    ‚ûï Agregar fila
                </button>
            </div>
        
            <div class="card-body">
                <div class="detalle-container" id="detalle-container-{{ forloop.counter0 }}">
                    <!-- FILA BASE -->
                    <div class="row detalle-row mb-2">
                        {% for field in det.form %}
                            <div class="col-md-3 mb-2">
                                <label class="form-label">{{ field.label }}</label>
                                {{ field }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
      
    {% endif %}

    <button type="submit" class="btn btn-primary">
        Guardar estructura del m√≥dulo
    </button>
</form>


<script>
function agregarFila(index) {
    const container = document.getElementById(`detalle-container-${index}`);
    const filas = container.getElementsByClassName("detalle-row");

    if (filas.length === 0) return;

    // Clonar la primera fila
    const nuevaFila = filas[0].cloneNode(true);

    // Limpiar valores
    const inputs = nuevaFila.querySelectorAll("input, select, textarea");
    inputs.forEach(input => {
        if (input.type === "checkbox" || input.type === "radio") {
            input.checked = false;
        } else {
            input.value = "";
        }
    });

    container.appendChild(nuevaFila);
}



document.addEventListener("DOMContentLoaded", function () {

    const input = document.getElementById("id_imagen");
    const preview = document.getElementById("preview_imagen");

    if (!input || !preview) return;

    input.addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
            preview.style.display = "none";
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
        };
        reader.readAsDataURL(file);
    });

});
</script>

</body>
</html>
